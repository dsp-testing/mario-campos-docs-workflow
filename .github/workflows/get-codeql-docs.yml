name: 1. Get CodeQL docs updates

on:
  # TODO: remove these when bringing to github/codeql-docs.
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  workflow_dispatch:
    inputs:
      download_branch:
        description: The branch in github/semmle-code to download the artifacts from
        required: true
        default: codeql-cli-X.X.X

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BRANCH_NAME: "codeql-docs-update/${{ github.event.inputs.download_branch }}/${{ github.run_id }}"

    steps:
    - name: Install Spark dependencies
      run: |
        sudo apt update
        sudo apt install libpcre16-3 libpcre3 libpcre3-dev libpcre32-3 libpcrecpp0v5

    - name: Setup spark
      #env:
        # TODO: Use a PAT with sufficient permissions to github/codeql-spark.
        #GH_TOKEN: ${{ secrets.CODEQL_SPARK_TOKEN }}
      run: |
        gh -R dsp-testing/mario-campos-docs-workflow release download v1.0.0
        unzip "spark-$RUNNER_OS-$RUNNER_ARCH.zip"

    # NOTE: The spark executable is placed in $GITHUB_WORKSPACE by the
    # setup-spark action, because the "templates" directory must be in
    # the CWD for spark to find it.
    - name: Generate ReStructuredText documentation from Markdown documentation
      env:
        # TODO: Use a PAT with sufficient permissions to github/codeql-owasp-top10-coverage.
        GH_TOKEN: ${{ github.token }}
      run: ./spark sitedocs

    - name: Check for changes to src/
      id: changes
      run: |
        if git diff --quiet src
        then
          echo "No changes detected in src/; nothing to deploy."
          echo "changed=false" >> "$GITHUB_OUTPUT"
        else
          echo "changed=true" >> "$GITHUB_OUTPUT"
        fi

    - name: Commit changes as github-actions bot
      if: steps.changes.outputs.changed == 'true'
      run: |
        git checkout -b "$BRANCH_NAME"
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add src docs/docs
        git commit --allow-empty -m "update codeql documentation"
        git push origin "$BRANCH_NAME"

    - name: Create Pull Request
      if: steps.changes.outputs.changed == 'true'
      env:
        GH_TOKEN: ${{ secrets.DOCS_BOT_PAT_BASE }}
        DOWNLOAD_BRANCH: ${{ github.event.inputs.download_branch }}
      run: |
        gh pr create \
          --base main \
          --head "$BRANCH_NAME" \
          --title "[CodeQL docs] Automated PR with updates from $DOWNLOAD_BRANCH" \
          --reviewer "$GITHUB_ACTOR" \
          --body-file <(cat <<EOF
          PR generated by actions to update the CodeQL docs.
          Updating the docs with changes generated from the '$DOWNLOAD_BRANCH' branch.

          If you want to request a review by the Docs content team, please add the \`ready-for-doc-review\` label. This will add the PR to our review board and we'll aim to review it within the next 2 days. For more urgent help, ask in #docs-content.

          Opening this PR will trigger deployment of all changes to a preview site.
          - Wait for the preview site to deploy, you can see a link to details in the "check status" area of the PR.
          - Check the preview at the URL displayed when you click **Deployment** to view the deployment site.
          - Remember not to click any of the links in the header. Instead append \`/docs/\` to the URL to see the docs landing page.
          EOF
          )
